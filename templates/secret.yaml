{{/*
  Set / generate default values
*/}}
{{- $redisPassword := randAlpha 16 }}
{{- $userUsername := "user" }}
{{- $userPassword := randAlpha 32 }}
{{- $adminUsername := "admin" }}
{{- $adminPassword := randAlpha 32 }}
{{- $sessionEncryptKey := randAlpha 32 }}
{{- $sessionValidateKey := randAlpha 32 }}
{{/*
  Fetch existing secrets to avoid overwrting them
*/}}
{{- $secret := (lookup "v1" "Secret" .Release.Namespace "pycloud-env") }}
{{- if $secret }}
{{- $redisPassword = index $secret.data "redis.password" | b64dec }}
{{- $userPassword = index $secret.data "users.user.password" | b64dec }}
{{- $adminPassword = index $secret.data "users.admin.password" | b64dec }}
{{- $sessionEncryptKey = index $secret.data "sessionEncryptKey" | b64dec }}
{{- $sessionValidateKey = index $secret.data "sessionValidateKey" | b64dec }}
{{- end -}}

{{- $values := dict "Values" .Values "redisPassword" $redisPassword "adminUsername" $adminUsername "adminPassword" $adminPassword "userUsername" $userUsername "userPassword" $userPassword "sessionEncryptKey" $sessionEncryptKey "sessionValidateKey" $sessionValidateKey }}
---
apiVersion: v1
kind: Secret
metadata:
  name: "pycloud-env"
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  redis.password: {{ $redisPassword | b64enc | quote }}
  users.user.password: {{ $userPassword | b64enc | quote }}
  users.admin.password: {{ $adminPassword | b64enc | quote }}
  sessionEncryptKey: {{ $sessionEncryptKey | b64enc | quote }}
  sessionValidateKey: {{ $sessionValidateKey | b64enc | quote }}
---
apiVersion: v1
kind: Secret
metadata:
  name: "pycloud-config"
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  config.ini: {{ include "pypicloud.configini" $values | b64enc }}
